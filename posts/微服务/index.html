<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.123.7">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title> &middot; My New Hugo Site</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="http://XxRa1n.github.io/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="http://XxRa1n.github.io/css/poole.css">
  <link type="text/css" rel="stylesheet" href="http://XxRa1n.github.io/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="http://XxRa1n.github.io/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  
</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="http://XxRa1n.github.io/"><h1>My New Hugo Site</h1></a>
      <p class="lead">
      An elegant open source and mobile first theme for <a href="http://hugo.spf13.com">hugo</a> made by <a href="http://twitter.com/mdo">@mdo</a>. Originally made for Jekyll.
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="http://XxRa1n.github.io/">Home</a> </li>
        
      </ul>
    </nav>

    <p>&copy; 2024. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1></h1>
  <time datetime=0001-01-01T00:00:00Z class="post-date">Mon, Jan 1, 0001</time>
  <p>title: &ldquo;微服务&rdquo;
date: 2023-12-17 18:00:00 +0800
author: me
cover: &ldquo;-/images/example.png&rdquo;
tags:
- 代码
- web</p>
<hr>
<h1 id="微服务">微服务</h1>
<p>微服务
eureka注册中心
ribbon负载均衡
nacos注册中心</p>
<h2 id="1认识微服务">1.认识微服务</h2>
<p>服务拆分
服务间通讯</p>
<p>SpringCloud：</p>
<ul>
<li>注册中心：Eureka</li>
<li>服务远程调用：Feign(http协议)</li>
<li>配置中心：SpringCloudConfig</li>
<li>服务网关：SpringCloudGateway</li>
<li>服务监控和保护：Hystrix</li>
</ul>
<p><strong>微服务的原则</strong>
单一职责原则：每个服务只负责一个功能，每个服务有一个数据库</p>
<h2 id="2微服务的功能实现">2.微服务的功能实现</h2>
<h3 id="21-微服务之间的通讯">2.1 微服务之间的通讯</h3>
<p>每个服务都只负责一个功能，有单独的服务器，那么服务之间应该如何通讯？</p>
<h4 id="211-微服务之间的通讯使用java发送http请求">2.1.1 <strong>微服务之间的通讯</strong>：使用Java发送HTTP请求</h4>
<p><strong>负责发送HTTP请求的库：RestTemplate</strong></p>
<p>Demo：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#75715e">// 主类中，或者单独配置类中.把RestTemplate注入到IOC容器中</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Bean</span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> RestTemplate <span style="color:#a6e22e">restTemplate</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> RestTemplate();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Service类中</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Autowired</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> RestTemplate restTemplate;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> Order <span style="color:#a6e22e">queryOrderById</span>(Long orderId){
</span></span><span style="display:flex;"><span>    Order order <span style="color:#f92672">=</span> orderMapper.<span style="color:#a6e22e">findById</span>(orderId);
</span></span><span style="display:flex;"><span>    String url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://localhost:8081/user/&#34;</span> <span style="color:#f92672">+</span> order.<span style="color:#a6e22e">getUserId</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 发送HTTP请求</span>
</span></span><span style="display:flex;"><span>    User user <span style="color:#f92672">=</span> restTemplate.<span style="color:#a6e22e">getForObject</span>(url, User.<span style="color:#a6e22e">class</span>);
</span></span><span style="display:flex;"><span>    order.<span style="color:#a6e22e">setUser</span>(user);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> order
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="212-管理微服务通讯eureka">2.1.2 管理微服务通讯：Eureka</h4>
<p>Eureka的组成：</p>
<ul>
<li>Eureka Server：服务注册中心
<ul>
<li>记录服务信息</li>
<li>心跳监控</li>
</ul>
</li>
<li>Eureka Client：服务提供者和服务消费者(即接收http请求的微服务和发送http请求的微服务)
<ul>
<li>Provider：服务提供者
<ul>
<li>启动时注册自己的信息到Eureka Server</li>
<li>每隔30s向Eureka Server发送心跳请求，报告健康状态</li>
</ul>
</li>
<li>Consumer：服务消费者
<ul>
<li>根据服务名称从Eureka Server拉取服务提供者的信息</li>
<li>基于服务列表做负载均衡，实现远程调用</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Eureka可以负载均衡，可以实现服务注册和服务发现，保证通讯可用。
（1）服务提供者启动时向Eureka注册自己的信息，包括IP地址、端口号、服务名称等
（2）消费者根据服务名称向eureka拉取提供者的信息
（3）服务提供者每30s向EurekaServer发送心跳请求，报告健康状态，防止服务不可用。</p>
<h4 id="213-搭建eureka-server">2.1.3 搭建Eureka Server</h4>
<ol>
<li>创建一个SpringBoot项目，引入Eureka Server依赖</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-server<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><ol start="2">
<li>编写启动类，在启动类中添加@EnableEurekaServer注解.</li>
<li>编写application.yml配置文件:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8761</span> <span style="color:#75715e"># Eureka Server端口，即Web服务端口</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">eureka-server</span> <span style="color:#75715e"># Eureka Server应用名称</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">eureka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">client</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">service-url</span>: <span style="color:#75715e"># 指定Eureka Server的地址;eureka会把自己也注册到服务列表中，用于集群通讯</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">defaultZone</span>: <span style="color:#ae81ff">http://localhost:8761/eureka</span>
</span></span></code></pre></div><h4 id="214-搭建eureka-client">2.1.4 搭建Eureka Client</h4>
<p><strong>user-service和order-service</strong>:
以user-service为例，order-service只有name不一样。</p>
<ol>
<li>创建一个SpringBoot项目，引入Eureka Client依赖</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span style="color:#f92672">&lt;/artifactId&gt;</span><span style="color:#75715e">&lt;!--注意引入的包不一样，这个是client--&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><ol>
<li>配置application.yml：</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">user-service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">eureka</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">client</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">service-url</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">defaultZone</span>: <span style="color:#ae81ff">http://localhost:8761/eureka</span> <span style="color:#75715e"># 写Eureka Server的地址</span>
</span></span></code></pre></div><h4 id="215-使用eureka管理http请求">2.1.5 使用Eureka管理http请求</h4>
<ul>
<li>修改访问地址</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>String url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://user-service/user/&#34;</span> <span style="color:#f92672">+</span> id;<span style="color:#75715e">// 用user-service注册的name替换原来的ip地址</span>
</span></span></code></pre></div><ul>
<li>负载均衡</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// 在RestTemplate Bean上增加@LoadBalanced注解</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@LoadBalanced</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> RestTemplate <span style="color:#a6e22e">restTemplate</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> RestTemplate();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="22-ribbon负载均衡">2.2 Ribbon负载均衡</h3>
<ul>
<li>负载均衡原理</li>
<li>负载均衡策略</li>
<li>懒加载</li>
</ul>
<p><strong>Ribbon工作流程图</strong>：
<img src="./images/Ribbon_workprocess.png" alt=""></p>
<p><strong>Ribbon负载均衡规则</strong>：每一个类对应一个具体的规则
<img src="./images/Ribbon_IRule.png" alt=""></p>
<p>默认的负载均衡规则是ZoneAviodenceRule
<strong>调整Ribbon负载均衡规则</strong>：
1.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#75715e">// 将规则类注入到容器中</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> IRule <span style="color:#a6e22e">randomRule</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> RandomRule();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>2.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 在application.yml中</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">user-service</span>: <span style="color:#75715e"># 对应的服务名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ribbon</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">NFLoadBalancerRuleClassName</span>: <span style="color:#ae81ff">com.netflix.loadbalancer.RandomRule</span> <span style="color:#75715e"># 负载均衡规则</span>
</span></span></code></pre></div><p><strong>懒加载</strong>:
Ribbon默认是采用懒加载，即第一次访问时才会去创建LoadBalanceClient，请求时间会很长。
而饥饿加载则会在项目启动时创建，降低第一次访问的耗时，但项目启动速度会变慢。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">ribbon</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">eager-load</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e"># 开启饥饿加载</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">clients</span>: 
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">user-service</span> <span style="color:#75715e"># 指定饥饿加载的服务名称</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">xx-service</span>
</span></span></code></pre></div><h3 id="23-nacos注册中心">2.3 Nacos注册中心</h3>
<p>Nacos和Eureka类似，也是基于服务注册和发现机制的，但是比Eureka功能更强大。
同时Nacos是SpringCloud的组件之一。在国内很受欢迎。</p>
<h4 id="231-nacos的使用">2.3.1 Nacos的使用</h4>
<p><strong>使用Nacos的步骤</strong>：</p>
<blockquote>
<p>注意：Nacos和Eureka只保留一个</p>
</blockquote>
<p>(1)下载并启动Nacos
下载安装包，运行.sh或者.cmd文件即可运行Nacos Server
可在配置文件中更改Nacos使用的端口
(2)在SpringCloud项目中引入Nacos的依赖
在父工程中添加spring-cloud-alibaba的管理依赖，管理版本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>com.alibaba.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-alibaba-dependencies<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;version&gt;</span>2.2.5.RELEASE<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;type&gt;</span>pom<span style="color:#f92672">&lt;/type&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;scope&gt;</span>import<span style="color:#f92672">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>在子工程中添加Nacos的依赖</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>com.alibaba.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>(3)配置application.yml
user-service和order-service同理</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">name-server</span> <span style="color:#75715e"># user-service或者order-service;自己命名</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cloud</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nacos</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">server-addr</span>: <span style="color:#ae81ff">127.0.0.1</span>:<span style="color:#ae81ff">8848</span> <span style="color:#75715e"># Nacos Server的地址</span>
</span></span></code></pre></div><h4 id="232-nacos服务分级存储模型">2.3.2 Nacos服务分级存储模型</h4>
<p>引入集群的概念，优先访问同一集群的资源</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cloud</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nacos</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">server-addr</span>: <span style="color:#ae81ff">127.0.0.1</span>:<span style="color:#ae81ff">8848</span> <span style="color:#75715e"># nacos 服务端地址</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">discovery</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cluster-name</span>: <span style="color:#ae81ff">BJ</span> <span style="color:#75715e"># 集群名称</span>
</span></span></code></pre></div><h4 id="234-nacos的负载均衡">2.3.4 Nacos的负载均衡</h4>
<p>同样用Ribbon做负载均衡
方法1：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">user-service</span>: <span style="color:#75715e"># 微服务名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ribbon</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">NFLoadBalancerRuleClassName</span>: <span style="color:#ae81ff">com.alibaba.cloud.nacos.ribbon.NacosRule</span> <span style="color:#75715e"># 负载均衡规则</span>
</span></span></code></pre></div><p>方法2：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> IRule <span style="color:#a6e22e">randomRule</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> RandomRule();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="235-nacos权重设置">2.3.5 Nacos权重设置</h4>
<p>可直接访问Nacos网址，可视化修改
如果权重为0，则该实例不会被访问到。可用于维护和升级</p>
<h4 id="236-nacos环境隔离">2.3.6 Nacos环境隔离</h4>
<p>环境隔离:
最高级：Namespace
次一级：Group
最低级：Service/Data
<strong>不用namespace中的实例无法相互访问</strong></p>
<p>可以访问Nacos网址可视化新建namespace
然后在application.yml中配置微服务属于哪个namespace</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">cloud</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nacos</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server-addr</span>: <span style="color:#ae81ff">localhost:8848</span> <span style="color:#75715e"># Nacos Server地址</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">discovery</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cluster-name</span>: <span style="color:#ae81ff">BJ</span> <span style="color:#75715e"># 集群名称</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">xxxx-xxxx-xxxx-xxx</span> <span style="color:#75715e"># namespace Id 可在Nacos操作页面中获取</span>
</span></span></code></pre></div><h4 id="237-nacos工作细节">2.3.7 Nacos工作细节</h4>
<p><img src="./images/Nacos_details.png" alt="">
Nacos中服务可以选择临时实例和非临时实例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cloud</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nacos</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">discovery</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ephemeral</span>: <span style="color:#66d9ef">false</span> <span style="color:#75715e"># 设为非临时实例</span>
</span></span></code></pre></div><h4 id="238-nacos与eureka的异同">2.3.8 Nacos与Eureka的异同</h4>
<p>相同点：</p>
<ul>
<li>都支持服务注册与服务拉取</li>
<li>都支持服务提供者心跳方式做健康检测</li>
</ul>
<p>不同点：</p>
<ul>
<li>Nacos支持服务端主动检测提供者状态：临时实例采用心跳模式，非临时实例采用主动检测模式</li>
<li>临时实例心跳不正常会被剔除，而非临时实例则不会被剔除</li>
<li>Nacos支持服务列表变更的消息推送模式，服务列表更新更及时</li>
<li>Nacos集群默认采用AP方式，当集群中存在非临时实例时，采用CP模式；Eureka采用AP方式</li>
</ul>
<h4 id="239-nacos统一配置管理">2.3.9 Nacos统一配置管理</h4>
<h5 id="使用nacos统一配置管理功能">使用Nacos统一配置管理功能</h5>
<p>引入Nacos配置管理客户端依赖：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>com.alibaba.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-nacos-config<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>在Nacos管理界面-&gt;配置管理-&gt;配置列表-&gt;新建配置
指定配置文件名称,例如:userservice-dev.yaml
如何加载userservice-dev.yaml配置？一般在userservice的resource目录中添加一个bootstrap.yml引导文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">userservice</span> <span style="color:#75715e"># 服务名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">profiles</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">active</span>: <span style="color:#ae81ff">dev</span> <span style="color:#75715e"># 开发环境，这里是dev，代表userservice-dev.yaml</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cloud</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nacos</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">server-addr</span>: <span style="color:#ae81ff">localhost:8848</span> <span style="color:#75715e"># Nacos Server地址</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">config</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">file-extension</span>: <span style="color:#ae81ff">yaml</span> <span style="color:#75715e"># 文件后缀名</span>
</span></span></code></pre></div><blockquote>
<p><strong>注意：nacos中的bootstrap.yml配置文件优先于spring中的application.yml配置;application.yml中不需要重复配置</strong></p>
</blockquote>
<p>完成以上配置以后，可以通过@Value注解读取Nacos中的配置信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">pattern</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">dateformat</span>: <span style="color:#ae81ff">yyyy-MM-dd HH:mm:ss</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#a6e22e">@Value</span>(<span style="color:#e6db74">&#34;${pattern.dateformat}&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> String dateformat;
</span></span></code></pre></div><h5 id="nacos配置热更新">Nacos配置热更新</h5>
<p>1.使用@Value注入
在使用@Value注解读取Nacos配置的Java类上添加@RefreshScope注解实现配置的热更新</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#a6e22e">@RefreshScope</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserController</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Value</span>(<span style="color:#e6db74">&#34;${pattern.dateformat}&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String dateformat;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>2.使用@ConfigurationProperties注入</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#a6e22e">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Data</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ConfigurationProperties</span>(prefix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;pattern&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PatternProperties</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String dateformat;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>不需要@RefreshScope注解就可以热更新</p>
<h4 id="2310-nacos多环境配置共享">2.3.10 Nacos多环境配置共享</h4>
<p>微服务启动时会从nacos读取多个配置文件：</p>
<ul>
<li>[spring.application.name]-[spring.profiles.active].yaml,例如:userservice-dev.yaml</li>
<li>[spring.application.name].yaml,例如:userservice.yaml</li>
</ul>
<p>[spring.application.name].yaml一定会加载，因此多环境共享配置可以写入这个文件</p>
<p>配置环境优先级：
服务名-profile.yaml &gt; 服务名.yaml &gt; 本地配置</p>
<p>其中[服务名-profile.yaml,服务名.yaml]是nacos中的配置
本地配置时spring中application.yml中的配置</p>
<h4 id="2311-nacos集群">2.3.11 Nacos集群</h4>
<ul>
<li>cluster.conf中配置集群IP地址</li>
<li>nacos的application.properties中mysql数据库的信息</li>
<li>运行.sh或者.cmd文件启动每个Nacos服务</li>
</ul>
<p>Nginx负载均衡：</p>
<ul>
<li>配置nginx.conf文件</li>
</ul>
<pre tabindex="0"><code class="language-conf" data-lang="conf">upstream nacos-cluster {
  server 127.0.0.1:8845;
  server 127.0.0.1:8846;
  server 127.0.0.1:8847;
}

server {
  listen      80;
  server_name localhost;
  
  location /nacos {
    proxy_pass http://nacos-cluster;
  }
}
</code></pre><h3 id="24-feign远程调用">2.4 Feign远程调用</h3>
<h4 id="241-介绍feign">2.4.1 介绍Feign</h4>
<p>Feign是一个声明式http客户端
Feign的作用就是实现高校的http请求发送</p>
<h4 id="242-feign依赖">2.4.2 Feign依赖</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><h4 id="243-开启feign功能">2.4.3 开启Feign功能</h4>
<p>在服务的请求方,order-service的启动类中添加<code>@EnableFeignClients</code>开启Feign功能</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#a6e22e">@EnableFeignClients</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OrderApplication</span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args){
</span></span><span style="display:flex;"><span>    SpringApplication.<span style="color:#a6e22e">run</span>(OrderApplication.<span style="color:#a6e22e">class</span>, args);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="244-定义feign接口使用feign">2.4.4 定义Feign接口(使用Feign)</h4>
<p>定义发送请求的接口</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#a6e22e">@FeignClient</span>(name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;user-service&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">UserClient</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">@GetMapping</span>(<span style="color:#e6db74">&#34;/user/{id}&#34;</span>)
</span></span><span style="display:flex;"><span>  User <span style="color:#a6e22e">findById</span>(<span style="color:#a6e22e">@PathVariable</span>(<span style="color:#e6db74">&#34;id&#34;</span>) Long id);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>@FeignClient(name = &quot;user-service&quot;)</code>表示请求的IP
<code>@GetMapping(&quot;/user/{id}&quot;)</code>表示请求的路径</p>
<p><strong>和SpringMVC的写法基本一致</strong>
只需要接口,不需要实现类.</p>
<h4 id="245-feign负载均衡">2.4.5 Feign负载均衡</h4>
<p>Feign内部集成Ribbon</p>
<h4 id="246-feign自定义配置">2.4.6 Feign自定义配置</h4>
<table>
<thead>
<tr>
<th>类型</th>
<th>作用</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>feign.Logger.Level</td>
<td>修改日志级别</td>
<td>包含四种:NONE,BASIC,HEADERS,FULL</td>
</tr>
<tr>
<td>feign.codec.Decoder</td>
<td>响应结果的解析器</td>
<td>http远程调用的结果作解析，例如解析json字符串为java对象</td>
</tr>
<tr>
<td>feign.codec.Encoder</td>
<td>请求参数编码</td>
<td>将请求参数编码，便于通过http请求发送</td>
</tr>
<tr>
<td>feign. Contract</td>
<td>支持的注解格式</td>
<td>默认是SpringMVC的注解</td>
</tr>
<tr>
<td>feign. Retryer</td>
<td>失败重试机制</td>
<td>请求失败的重试机制，默认是没有，不过会使用Ribbon的重试</td>
</tr>
</tbody>
</table>
<p>两种修改的方式：以修改Logger为例
1.配置文件
(1)全局生效：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">feign</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">client</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">default</span>: <span style="color:#75715e"># default表示全局配置</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">loggerLevel</span>: <span style="color:#ae81ff">FULL</span> <span style="color:#75715e">#日志级别</span>
</span></span></code></pre></div><p>(2)局部生效：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">feign</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">client</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">userservice</span>: <span style="color:#75715e"># userservice是某个服务的名称，表示只在这个服务中生效</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">loggerLevel</span>: <span style="color:#ae81ff">FULL</span> <span style="color:#75715e">#日志级别</span>
</span></span></code></pre></div><p>2.Bean注入</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FeignClientConfiguration</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> Logger.<span style="color:#a6e22e">Level</span> <span style="color:#a6e22e">feignLoggerLevel</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> Logger.<span style="color:#a6e22e">Level</span>.<span style="color:#a6e22e">BASIC</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>(1)全局生效：
修改启动类注解:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#a6e22e">@EnableFeignClients</span>(defaultConfiguration <span style="color:#f92672">=</span> FeignClientConfiguration.<span style="color:#a6e22e">class</span>)
</span></span></code></pre></div><p>(2)局部生效：
修改FeignClient注解(Feign请求接口的注解)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#a6e22e">@FeignClient</span>(name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;userservice&#34;</span>,configuration <span style="color:#f92672">=</span> FeignClientConfiguration.<span style="color:#a6e22e">class</span>)
</span></span></code></pre></div><h4 id="247-feign的性能优化">2.4.7 Feign的性能优化</h4>
<p>Feign底层的客户端实现:</p>
<ul>
<li>URLConnection:默认实现,不支持连接池</li>
<li>Apache HttpClient:支持连接池</li>
<li>OKHttp:支持连接池</li>
</ul>
<p>优化Feign的性能主要包括：
（1）使用连接池代替默认的URLConnection
（2）日志级别，最好用BASIC或NONE</p>
<h5 id="用httpclient替换feign的urlconnection">用HttpClient替换Feign的URLConnection</h5>
<p><strong>依赖</strong>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;groupId&gt;</span>io.github.openfeign<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;artifactId&gt;</span>feign-httpclient<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p><strong>配置连接池</strong>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">feign</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">client</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">config</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">default</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">loggerLevel</span>: <span style="color:#ae81ff">BASIC</span> <span style="color:#75715e">#日志级别，推荐BASIC或NONE，不推荐FINEST，因为会打印太多日志</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">httpclient</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e">#开启HttpClient支持</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">max-connections</span>: <span style="color:#ae81ff">200</span> <span style="color:#75715e">#最大连接数</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">max-connections-per-route</span>: <span style="color:#ae81ff">50</span> <span style="color:#75715e">#每个路径的最大连接数</span>
</span></span></code></pre></div><h3 id="25-gateway网关">2.5 Gateway网关</h3>
<p>由SpringCloudGateway实现网关功能
SpringCloudGateway:基于Spring5中提供的WebFlux，属于响应式编程的实现。</p>
<p>网关功能：</p>
<ul>
<li>身份认证和权限校验</li>
<li>服务路由、负载均衡</li>
</ul>
<blockquote>
<p>Gateway是一个单独的微服务</p>
</blockquote>
<h4 id="251-依赖">2.5.1 依赖</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;!-- 网关依赖 --&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-gateway<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">&lt;!-- nacos服务发现依赖 --&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;groupId&gt;</span>com.alibaba.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-alibaba-nacos-discovery<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><h4 id="252-配置文件">2.5.2 配置文件</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">10010</span> <span style="color:#75715e"># 网关端口</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">gateway</span> <span style="color:#75715e"># 应用名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cloud</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nacos</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">server-addr</span>: <span style="color:#ae81ff">localhost:8848</span> <span style="color:#75715e"># nacos地址</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">gateway</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">routes</span>: <span style="color:#75715e"># 网关路由配置</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">id</span>: <span style="color:#ae81ff">user-service</span> <span style="color:#75715e"># 路由id，自定义，只要唯一即可</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">uri</span>: <span style="color:#ae81ff">lb://user-service</span> <span style="color:#75715e"># 路由的目标地址。lb表示负载均衡，后面跟服务名称</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">predicates</span>: <span style="color:#75715e"># 路由断言,判断请求是否符合路由规则的条件</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">Path=/user/**</span> <span style="color:#75715e"># 匹配所有以/user/开头的请求路径</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">id</span>: <span style="color:#ae81ff">user2-service</span> <span style="color:#75715e"># 路由id，自定义，只要唯一即可</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">uri</span>: <span style="color:#ae81ff">lb://user2-service</span> <span style="color:#75715e"># 路由的目标地址。lb表示负载均衡，后面跟服务名称</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">predicates</span>: <span style="color:#75715e"># 路由断言,判断请求是否符合路由规则的条件</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">Path=/user2/**</span> <span style="color:#75715e"># 匹配所有以/user/开头的请求路径</span>
</span></span></code></pre></div><p><strong>断言</strong>:
predicates中的字符串由断言工厂负责解析。
SpringCloudGateway提供了11种基本的Predicate工厂</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>After</td>
<td>匹配在某个时间之后的请求</td>
<td>-After=xxx</td>
</tr>
<tr>
<td>Before</td>
<td>匹配在某个时间之前的请求</td>
<td>-Before=xxx</td>
</tr>
<tr>
<td>Between</td>
<td>匹配在某个时间段内的请求</td>
<td>-Between=xxx</td>
</tr>
<tr>
<td>Cookie</td>
<td>请求必须包含某个Cookie</td>
<td>-Cookie=xxx,yyy</td>
</tr>
<tr>
<td>Header</td>
<td>请求必须包含某些Header</td>
<td>-Header=xxx,yyy</td>
</tr>
<tr>
<td>Host</td>
<td>请求必须包含某些Host(域名)</td>
<td>-Host=xxx,yyy</td>
</tr>
<tr>
<td>Method</td>
<td>请求方式必须是指定的方式</td>
<td>-Method=GET,POST</td>
</tr>
<tr>
<td>Path</td>
<td>请求路径必须符合指定模式</td>
<td>-Path=/foo/{segment},/foo/bar</td>
</tr>
<tr>
<td>Query</td>
<td>请求参数必须包含某些参数</td>
<td>-Query=name</td>
</tr>
<tr>
<td>RemoteAddr</td>
<td>请求必须来自某个IP地址</td>
<td>-RemoteAddr=192.168.1.1/24</td>
</tr>
<tr>
<td>Weight</td>
<td>权重处理</td>
<td></td>
</tr>
</tbody>
</table>
<p><strong>过滤器</strong>：
GatewayFilter是网关中提供的一种过滤器，可以对进入网关的请求和微服务返回的响应做处理。
使用spring.cloud.gateway.routes.filters配置</p>
<p>代码示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cloud</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">gateway</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">routes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">id</span>: <span style="color:#ae81ff">user-service</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">uri</span>: <span style="color:#ae81ff">lb://user-service</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">predicates</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">Path=/user/**</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">filters</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">AddRequestHeader=X-Request-Foo, Bar</span>
</span></span></code></pre></div><p>详细配置规则请看官方文档</p>
<p><strong>默认过滤器</strong>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cloud</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">gateway</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">routes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">id</span>: <span style="color:#ae81ff">user-service</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">uri</span>: <span style="color:#ae81ff">lb://user-service</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">predicates</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">Path=/user/**</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">filters</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">AddRequestHeader=X-Request-Foo, Bar</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">default-filters</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">AddRequestHeader=X-Request-Default-Foo, Default-Bar</span>
</span></span></code></pre></div><p>spring.cloud.gateway.default-filters是默认过滤器，对所有路由请求都生效</p>
<p><strong>全局过滤器GlobalFilter</strong>:
全局过滤器的作用也是处理一切进入网关的请求和微服务响应，与GatewayFilter的作用一样。
区别在于GatewayFilter通过配置定义，处理逻辑是固定的；而GlobalFilter的逻辑需要自己写代码实现。</p>
<p>实现GlobalFilter接口:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">GlobalFilter</span> {
</span></span><span style="display:flex;"><span>  Mono<span style="color:#f92672">&lt;</span>Void<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">filter</span>(ServerWebExchange exchange, GatewayFilterChain chain);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>过滤器执行顺序</strong>:
通过order值决定执行顺序，order值越小越优先执行</p>
<p>GlobalFilter通过添加@Order注解或者实现getOrder()方法返回int值来指定order值。
路由过滤器和defaultFilter的order值由Spring容器指定，默认是按照声明顺序从1递增。
当过滤器order值一样时：按照defaultFilter&gt;路由过滤器&gt;GlobalFilter的顺序执行。</p>
<p><strong>跨域问题处理</strong>：
通过添加配置就可以解决</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cloud</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">gateway</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">globalcors</span>: <span style="color:#75715e"># 全局的跨域处理</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">add-to-simple-url-handler-mapping</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e"># 解决options请求被拦截问题</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">corsConfigurations</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#39;[/**]&#39;</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">allowedOrigins</span>: <span style="color:#75715e"># 允许哪些网站的跨域请求</span>
</span></span><span style="display:flex;"><span>              - <span style="color:#e6db74">&#34;http://localhost:8090&#34;</span>
</span></span><span style="display:flex;"><span>              - <span style="color:#e6db74">&#34;http://www.leyou.com&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">allowedMethods</span>: <span style="color:#75715e"># 允许的跨域ajax的请求方式</span>
</span></span><span style="display:flex;"><span>              - <span style="color:#e6db74">&#34;GET&#34;</span>
</span></span><span style="display:flex;"><span>              - <span style="color:#e6db74">&#34;POST&#34;</span>
</span></span><span style="display:flex;"><span>              - <span style="color:#e6db74">&#34;DELETE&#34;</span>
</span></span><span style="display:flex;"><span>              - <span style="color:#e6db74">&#34;PUT&#34;</span>
</span></span><span style="display:flex;"><span>              - <span style="color:#e6db74">&#34;OPTIONS&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">allowedHeaders</span>: <span style="color:#e6db74">&#34;*&#34;</span> <span style="color:#75715e"># 允许在请求中携带的头信息</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">allowCredentials</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e"># 是否允许携带cookie</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">maxAge</span>: <span style="color:#ae81ff">3628800</span> <span style="color:#75715e"># 这次跨域检测的有效期</span>
</span></span></code></pre></div>
</div>


    </main>

    
      
    
  </body>
</html>
